---
title: "EDA"
author: "Orphelia"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, errors=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir = here::here())
options(warn=-1)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(chron))
suppressPackageStartupMessages(library(splusTimeDate))
suppressPackageStartupMessages(library(RQuantLib))
suppressPackageStartupMessages(library(kableExtra))
library(plotly)
library(igraph) 
library(network) 
library(sna)
#library(ggraph)
#library(visNetwork)
#library(threejs)
#library(networkD3)
#library(ndtv)
#library(GGally)
#library(MASS)
#library(cdparcoord)
library(tmap)
library(tmaptools)
library(leaflet)
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library(conflicted)
```

```{r}
data <- read_csv("data/Relationship_bloodGrp_cleaned.csv") 

data$Reside[data$Reside == 'Hong Kong'] <- 'China'

#data %>% select(Reside) %>% arrange(Reside) %>% group_by(Reside) %>% summarize(count = n())
```

## I- About participants 

- 407 participants from 41 countries residing in 30 countries
- 3 main countries of origin: 29% Ivory Coast, 19% Nigeria, 18% India, 5% Canada
- 3 main countries of residence: 24% USA, 20% Canada, 12% Nigeria

<br></br>

- Below is an interactive map of participants' countries of origin and residence:


```{r}
#load a R dataset of countries with their lat and long 
# select disntinct country

world_data <- data.frame(map_data("world"))

# rename some countries
world_data$region[world_data$region == 'Republic of Congo'] <- 'Congo'
world_data$region[world_data$region =='Czech Republic'] <- 'Czech'
world_data$region[world_data$region =='United Arab Emirates'] <- 'UAE'


world_data <- world_data %>% 
select(region, lat, long) %>% 
arrange(region) %>% 
group_by(region) %>% 
mutate(group = row_number()) %>% 
dplyr::filter(group == 1) %>% 
select(-group) %>% 
ungroup()

# combine country of origin and country of residence into 1 column

countries_origin <- data %>% 
  select(Origin) %>% 
  rename(country= Origin) %>% 
  unique()

countries_residence <- data %>% 
  select(Reside) %>% 
  rename(country = Reside) %>% 
  unique()

countries <- rbind(countries_origin, countries_residence) %>% 
  unique()

# count of countries of origin and residence

origin <- data %>% 
  select(Origin) %>%
  rename(country = Origin) %>% 
  arrange(country) %>% 
  group_by(country) %>% 
  summarize(count_origin = n()) %>% 
  ungroup()

reside <- data %>% 
  select(country = Reside) %>% 
  arrange(country) %>% 
  group_by(country) %>% 
  summarize(count_residence = n()) %>% 
  ungroup()

#join countries and counts above

countries2 <- countries %>% 
  left_join(origin) %>% 
  left_join(reside) %>% 
  mutate(count_origin = replace_na(count_origin,0)) %>% 
  mutate(count_residence = replace_na(count_residence,0)) %>% 
 left_join(world_data, 
                   by = c('country' = 'region')) %>% 
  rename(lon = long) %>% 
  drop_na() 

#countries2 %>% dplyr::filter(is.null(lat))

```


- **Interactivity**: click on circles or icons to display country name, count of participants from and residing in the country 

- **Circle Color and Size**: driven by count of participants from a given country :

    - less than 10 : <span style="color: green;">green</span>
    - 10 - 30 : <span style="color: yellow;">yellow</span>
    - 30 - 50: <span style="color: orange;">orange</span>
    - greater than 50 : <span style="color: red;">red</span>
    
<br></br>
```{r}
# map

trucks = makeAwesomeIcon(
  icon = 'fas fa-truck fa-3x',
  iconColor = 'black',
  library = 'fa'
)

country_map = leaflet(data = countries2,
                           (width = "100%")) %>%
  addProviderTiles(providers$Stamen.Toner, options = providerTileOptions(opacity = 0.45)) %>%
  addAwesomeMarkers(icon = trucks,
                    lat = countries2$lat,
                    lng = countries2$lon,
                    popup = paste0("Country: ", countries2$country, "<br>",
                                   "Origin: ",countries2$count_origin , "<br>",
                                   "Reside: ",countries2$count_residence, "<br>"),

                    clusterOptions = markerClusterOptions(maxClusterRadius = 50)) %>%
  addCircleMarkers(radius= countries2$count_origin/10,
                   
                   color=~case_when(countries2$count_origin < 10 ~ "green",
                                    (countries2$count_origin >= 10 & countries2$count_origin < 30) ~ "yellow",
                                   (countries2$count_origin >= 30 & countries2$count_origin < 50) ~ "orange",
                                    countries2$count_origin>= 50 ~ "red"),
                   lat = countries2$lat,
                   lng = countries2$lon,
                   fillOpacity = 0.5,
                   popup = paste0("Country: ", countries2$country, "<br>",
                                   "Origin: ",countries2$count_origin , "<br>",
                                   "Reside: ",countries2$count_residence, "<br>"
                                  )
                   )
  

country_map
```

<br></br>
```{r}
origin <- data %>% 
  select(Origin) %>% 
  arrange(Origin) %>% 
  group_by(Origin) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  mutate (percent = count/ sum(count)) %>% 
  mutate(percent = round(percent ,2))


reside <- data %>% 
  select(Reside) %>% 
  arrange(Reside) %>% 
  group_by(Reside) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  mutate (percent = count/ sum(count)) %>% 
  mutate(percent = round(percent ,2)*100)
```

### Distribution of Participants' blood types vs. Distribution in main countries
[Source](https://en.wikipedia.org/wiki/Blood_type_distribution_by_country)

<br></br>

```{r}
bt <- data %>% 
  select(BldGrp) %>% 
  arrange(BldGrp) %>% 
  group_by(BldGrp) %>%
  summarize(count = n()) %>% 
  #arrange(desc(count)) %>% 
  mutate (percent = count/ sum(count)) %>% 
  mutate(percent = round(percent ,3)*100) %>% 
  select(-count) %>% 
  mutate('Ivory Coast' = c(1,22.5,0.2,4.3,1,22.5,2,46.5),
         'Nigeria' = c(0.7,22.4,0.1,2.6,0.6,20.7,1.6,51.3),
         'India' = c(0.57,20.8,0.49,8.93,1.79,38.14,1.43,27.85),
         'Canada' = c(6,36,0.5,2.5,1.4,7.6,7,39),
         'Kenya' = c(1,25.2,0.02,4.2,0.9,21.28,1.8,45.6),
         'Ghana' = c(1.3,17.6,0.2,2.8,1.3,18.3,4.5,53.8),
         'USA' = c(6.3,35.7,0.6,3.4,1.5,8.5,6.6,37.4))

colnames(bt) <- c('Blood Group','Participants (%)', 'Ivory Coast (%)', 'Nigeria (%)', 'India (%)', 'Canada (%)', 'Kenya (%)', 'Ghana (%)', 'USA (%)')

bt <- bt  %>% 
  mutate_if(is.numeric, ~round(., 1))

DT ::datatable(bt, style = "bootstrap", class = "table-hover", rownames = FALSE)
```

- The distribution of blood types in our sample is well aligned with that of the most represented countries. The major groups are:

    - 41% O+
    - 21% A+
    - 20% B+ 

<br></br>

### Gender, Relationship Status, Age

<br></br>

```{r, out.width= '100%', out.height= '100%'}
df <- data

df$Gender[df$Gender == "Prefer not to say"] <- "Undisclosed"


df <- df %>%
     select(Gender, InRel, AgeGroup)  %>% 
     drop_na()  %>% 
     gather(variable,value) %>%
     group_by(variable, value) %>% 
    summarize(count = n()) %>% 
    mutate (percent = count/ sum(count)) %>% 
    mutate(percent = round(percent ,2)*100)


#Plots
labels<- c(
    `Gender`="Gender",
    `InRel`="In Relationship",
    `AgeGroup`="Age Group")


plot <- ggplot(df,
       aes(x = value, y = percent))+ 
        geom_bar( stat="identity")+
        facet_wrap(~variable, scales = "free_x", labeller=as_labeller(labels))+
        theme_bw()+ 
        theme(panel.grid.major=element_blank(), 
            panel.grid.minor=element_blank(),
            strip.text.x=element_text(size=11),
            axis.text.x = element_text(angle = 50, hjust = 1))+
        xlab("")+
        ylab("Percent")
plot

#ggplotly(plot)
```

<br></br>

- 64% of participants are between 20 and 29 years old. The second biggest age group is 30 to 39 (27%) followed by 40 to 49 (5%)
- 54% of participants are Female , 46% Male
- 64% of participants are in a relationship


<br></br>

###  Relationship between the blood group of participants and their partners'

<br></br>
```{r}
heat_data <- data %>% 
  select(BldGrp, BldGrp_Prtnr) %>% 
  arrange(BldGrp, BldGrp_Prtnr) %>% 
  group_by(BldGrp, BldGrp_Prtnr) %>% 
  summarize(count = n()) %>% 
  mutate (percent = count/ sum(count)) %>% 
  mutate(percent = round(percent ,2)*100)

heat_data2 <- heat_data

colnames(heat_data2) <- c("Participants' Blood Type","Their Partners' Blood Type", 'Count', 'Percent')

DT ::datatable(heat_data2, style = "bootstrap", class = "table-hover", rownames = FALSE)
```
<br></br>
```{r,out.width= '100%', out.height= '100%'}

ggplot(data = heat_data, 
       mapping = aes(x = BldGrp,
                     y =  BldGrp_Prtnr,
                     fill = percent)) +
  geom_tile()+
  theme_bw()+
   theme(panel.grid.major=element_blank(), 
            panel.grid.minor=element_blank(),
            strip.text.x=element_text(size=11))+
  labs(x= "Participants' Blood Group",
       y = "Blood Group of Participants' partners")+
   scale_fill_gradient(name = "Percent",
                      low = "lightskyblue",
                      high = "navy")

#Although 42 partcipants who indicated being single answered *I don't know* to 'what is the blood group of your partner ?'

```


<br></br>

- This plot is called a heatmap. It is a chart that uses colors to represent values the way a bar plot uses height and width

<br></br>

- The chart shows the different combinations of participants' blood type and their partners'. The color spectrum varies from light sky blue (low percentage) to navy blue (high percentage)

<br></br>

- Most participants who indicated being in a relationship do not know the blood group of their partners as shown by the darker colors in the "I don't know" row

<br></br>

- A+ , B+ and O+ participants stand out. Those who are in a relationship and know their partners' blood type are more likely to date someone with the same blood group

    - A+: 18% A+, 12% O+

    - B+: 20% B+, 13% O+ 

    - O+: 15% O+, 8% B+
    
<br></br>

## II- Relationship between Blood Group and Personality 

### Excluding Rh factor: +/-

<br></br>
```{r}
data2 <- data %>% 
  mutate(Blood_group = case_when(BldGrp == 'O-' ~ 'O',
                                 BldGrp == 'O+' ~ 'O',
                                 BldGrp == 'A-' ~ 'A',
                                 BldGrp == 'A+' ~ 'A',
                                 BldGrp == 'B+' ~ 'B',
                                 BldGrp == 'B-' ~ 'B',
                                 BldGrp == 'AB-' ~ 'AB',
                                 BldGrp == 'AB+' ~ 'AB'))
```

```{r,out.width= '100%', out.height= '100%'}
plot_function <- function(var, my_title){
  
  plot_data <- data2 %>% 
    dplyr::select(Blood_group, var)
  
  plot_data %>% ggplot(aes(x = plot_data[[2]],
                              label = scales::percent(prop.table(stat(count))),
                              y = prop.table(stat(count)),
                              group = plot_data[[1]]))+
  geom_text(aes(label = round(..prop.., 2),
                y = ..prop..), stat= "count", 
            position = position_dodge(width = 0.5), 
            vjust =-0.25, 
            size = 2.5,
            color = 'red')+
  geom_bar(aes(y = ..prop..), stat = "count")+
  ylim(0, 1)+
  facet_wrap(~ plot_data[[1]])+
  theme_bw()+
  theme(panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            axis.title = element_text(size = 10),
            plot.title = element_text(size = 10),
            strip.text.x = element_text(size = 10),
            legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs( y = 'Proportion',
        title = my_title,
        x = '')
  
}


#ggplotly(plot1)
```


#### Group 1 : 
<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Enyj_Grp', 'I enjoy being part of a group')
```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Avoid_alone', "I avoid being alone")
```

<br></br>

```{r,out.width= '100%', out.height= '100%'}
plot_function('Get_Nervs_Talkng', "I get nervous talking to people I don't know")
```

<br></br>

```{r,out.width= '100%', out.height= '100%'}
plot_function('Enjy_attentn', "I enjoy being the center of attention")

```

<br></br>

```{r,out.width= '100%', out.height= '100%'}
plot_function('Fun_Party_Aftr_Wrk', "After an exhausting week a fun party is just what I need")
```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Hard_Trust_Ppl', "I find it hard to trust people")
```

<br></br>

#### Group 2 :

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Take_Chrg', 'I take charge')
```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('help_Ppl', 'I like helping people')
```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Like_Ordr', "I like order")
```
<br></br>

#### Group 3:

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Adventure', "I seek adventure")
```

<br></br>

```{r,out.width= '100%', out.height= '100%'}
plot_function('Variety_Routine', "I prefer variety to routine")

```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Focus_on_present', "I tend to focus on present realities rather than future possibilities")
```

<br></br>

```{r,out.width= '100%', out.height= '100%'}
plot_function('Go_With_Flow', "I would rather go with the flow than have a set schedule")
```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Detail_Orntd', "I am more of a detailed-oriented than a big picture person")

```

<br></br>

#### Group 4:
<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Feel_Emo', "I feel others' emotions")
```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Talk_abt_Own_Feelngs', "I often talk about my own feelings and emotions")
```

<br</br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Chs_Wrds_Care', 'I choose my words with care')
```


<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Modest_Achieve', "I am modest about what I have achieved")
```

<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Get_Upset', "I get upset easily")
```

<br></br>

```{r,out.width= '100%', out.height= '100%'}
plot_function('Avoid_Arguing', "I avoid arguing even when I disagree")
```
<br></br>
```{r,out.width= '100%', out.height= '100%'}
plot_function('Rarely_Insecure', "I rarely feel insecure")
```



<br><br>

- NEXT STEPS:

    - Name groups 
    - Interpret plots ... At a quick glance, AB people seem to stand out in many aspects
    - Find a way to make document shorter. Maybe make each group name clickable and plots are reveal upon clicling on links
    - Contibue analysis with psychometric traits that stand out: add Rh Factor 
    - Impact of age 
    - Impact of countries of residence vs. origin (focus on 3 main countries) 

